<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Metro Route Simulator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Modern, friendly Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    body {
      background: #f7f8fa;
      color: #232340;
      font-family: 'Urbanist', Arial, Helvetica, sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    .container {
      /* max-width: 1120px; */
      margin: 0 auto;
      padding: 34px 20px 0 20px;
    }
    h1 {
      font-family: 'Urbanist', sans-serif;
      font-weight: 900;
      font-size: 2.7rem;
      text-align: center;
      letter-spacing: 0.04em;
      margin: 0 0 24px 0;
    }
    .summary-row {
      display: flex; justify-content: center; margin-bottom: 20px; align-items: flex-end;
      flex-wrap: wrap;
      gap: 50px;
    }
    .summary-box {
      background: #fff;
      border-radius: 22px;
      padding: 22px 38px 22px 38px;
      min-width: 270px;
      margin: 5px;
      box-shadow: 0 8px 40px 0 #99caff32;
      text-align: center;
      font-size: 2.2rem;
      color: #212174;
      font-weight: 900;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .summary-label { font-size: 1.2rem; color: #94a0bc; font-weight: 700; margin-bottom: 0.28em; letter-spacing:0.04em;}
    #fee, #duration { color: #2140c2; font-size:2.5rem; letter-spacing:0.03em; }
    .controls {
      display: flex; justify-content: center; align-items: center;
      gap: 22px;
    }
    .dropdown {
      font-family: 'Urbanist', Arial, Helvetica, sans-serif;
      font-size: 1.18rem;
      background: #fafdff;
      color: #2e2e5a;
      border: 2px solid #dde6f7;
      border-radius: 16px;
      padding: 14px 38px 14px 20px;
      min-width: 260px;
      box-sizing: border-box;
      margin: 0 8px;
      font-weight: 700;
      outline: none;
      box-shadow: 0 2px 18px #dde6f4bb;
      transition: border 0.15s;
      cursor: pointer;
      text-align: center;
      text-overflow: ellipsis;
    }
    .dropdown:focus { border: 2px solid #4ba5ff; }
    /* Metro lines */
    .metro-map {
      display: block;
      margin: 0 auto;
    }
    .metro-map-container {
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .station-dot {
      cursor: pointer;
      stroke: #fff;
      stroke-width: 3.5;
      fill: #30b7e8;
      transition: fill 0.18s, stroke 0.2s;
    }
    .station-dot.lrt {
      fill: #e53e3e;
    }
    .station-dot.mrt {
      fill: #38a169;
    }
    .station-dot.interchange {
      fill: #805ad5;
    }
    .station-dot.selected {
      fill: #FFA300;
      stroke: #232340;
      stroke-width: 6;
    }
    .station-label {
      font-family: 'Urbanist', Arial, Helvetica, sans-serif;
      font-size: 1.01em;
      fill: #232340;
      font-weight: 700;
      text-anchor: end;
      pointer-events: none;
      user-select: none;
      transform: rotate(-36deg);
      /* will be applied via JS for SVG */
    }
    .line-main { stroke: #30b7e8; stroke-width: 7; }
    .line-lrt { stroke: #e53e3e; stroke-width: 7; }
    .line-mrt { stroke: #38a169; stroke-width: 7; }
    /* Tables */
    .tables-row {
      display: flex;
      gap: 36px;
      justify-content: center;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    .arr-table {
      background: #fff;
      border-radius: 20px;
      min-width: 260px;
      padding: 0 16px 18px 16px;
      margin-bottom: 10px;
      font-size: 1.15rem;
      color: #232340;
      box-shadow: 0 4px 26px #e3e8f2;
      border: 1.5px solid #e7e7ef;
    }
    .arr-table th, .arr-table td {
      border-bottom: 1.1px solid #e8e8ef;
      padding: 9px 14px;
      text-align: center;
    }
    .arr-table th {
      color: #38b0e6;
      font-weight: 900;
      font-size: 1.11em;
      background: #f7fafd;
      border-radius: 8px 8px 0 0;
    }
    .arr-table tr:last-child td { border-bottom: none; }
    @media (max-width: 950px) {
      .tables-row { flex-direction: column; align-items: center; gap: 20px; }
      .metro-map { height: 240px; }
      .container { padding: 18px; }
      .dropdown { min-width: 160px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Metro Route Simulator</h1>
    <div class="summary-row">
      <div class="summary-box">
        <div class="summary-label">Total Fee</div>
        <div id="fee">RMXX.XX</div>
      </div>
      <div class="summary-box">
        <div class="summary-label">Duration</div>
        <div id="duration">XX mins</div>
      </div>
    </div>

    <div class="controls">
      <select id="fromStation" class="dropdown"></select>
      <span style="font-size:2.2rem;color:#b3b3c7;">&hellip;</span>
      <select id="toStation" class="dropdown"></select>
    </div>

    <div class="metro-map-container">
      <svg class="metro-map" id="metroSVG" width="2000" height="520"></svg>
    </div>

    <div class="tables-row">
      <!-- Station 1 Tables -->
      <div style="display: flex; flex-direction: column; align-items: center; gap: 15px;">
        <h3 id="station1Title" style="margin: 0; font-size: 1.4rem; color: #2e2e5a;">Station 1</h3>
        <div id="station1Tables" style="display: flex; gap: 20px;">
          <!-- Tables will be dynamically generated based on station type -->
        </div>
      </div>
      
      <!-- Station 2 Tables -->
      <div style="display: flex; flex-direction: column; align-items: center; gap: 15px;">
        <h3 id="station2Title" style="margin: 0; font-size: 1.4rem; color: #2e2e5a;">Station 2</h3>
        <div id="station2Tables" style="display: flex; gap: 20px;">
          <!-- Tables will be dynamically generated based on station type -->
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
  <script>
    let stations = [];
    let stationMap = {};
    const socket = io();

    async function loadStations() {
      const res = await fetch('/stations');
      stations = await res.json();
      stationMap = {};
      stations.forEach(s => { stationMap[s.station_id] = s.name; stationMap[s.name] = s.station_id; });
      renderDropdowns();
      renderMetroSVG();
      document.getElementById('fromStation').value = stations[0].name;
      document.getElementById('toStation').value = stations[1].name;
      fetchRouteData();
      fetchArrivals();
    }

    function renderDropdowns() {
      let from = document.getElementById('fromStation');
      let to = document.getElementById('toStation');
      from.innerHTML = to.innerHTML = '';
      stations.forEach(s => {
        from.innerHTML += `<option value="${s.name}">${s.name}</option>`;
        to.innerHTML += `<option value="${s.name}">${s.name}</option>`;
      });
    }

    function renderMetroSVG() {
      const svg = document.getElementById('metroSVG');
      svg.innerHTML = '';
      
      // Define line positions
      const topLineY = 60; // Top line
      const bottomLineY = 280; // Bottom line
      const xStart = 65, xEnd = 1825;
      const labelAngle = -38; // degrees
      const interchangeX = 1000; // Fixed position for Pasar Seni interchange
      
      // Define all stations in order with their line assignments
      const allStations = [
        // LRT stations (Putra Heights to Pasar Seni) - RED line, bottom position
        { id: 37, name: 'Putra Heights (KJL)', line: 'lrt', isLeft: true },
        { id: 36, name: 'Subang Alam', line: 'lrt', isLeft: true },
        { id: 35, name: 'Alam Megah', line: 'lrt', isLeft: true },
        { id: 34, name: 'USJ 21', line: 'lrt', isLeft: true },
        { id: 33, name: 'Wawasan', line: 'lrt', isLeft: true },
        { id: 32, name: 'Taipan', line: 'lrt', isLeft: true },
        { id: 31, name: 'USJ 7 (KJL)', line: 'lrt', isLeft: true },
        { id: 30, name: 'SS 18', line: 'lrt', isLeft: true },
        { id: 29, name: 'SS 15', line: 'lrt', isLeft: true },
        { id: 28, name: 'Subang Jaya', line: 'lrt', isLeft: true },
        { id: 27, name: 'Glenmarie', line: 'lrt', isLeft: true },
        { id: 26, name: 'Ara Damansara', line: 'lrt', isLeft: true },
        { id: 25, name: 'Lembah Subang', line: 'lrt', isLeft: true },
        { id: 24, name: 'Kelana Jaya', line: 'lrt', isLeft: true },
        { id: 23, name: 'Taman Bahagia', line: 'lrt', isLeft: true },
        { id: 22, name: 'Taman Paramount', line: 'lrt', isLeft: true },
        { id: 21, name: 'Asia Jaya', line: 'lrt', isLeft: true },
        { id: 20, name: 'Taman Jaya', line: 'lrt', isLeft: true },
        { id: 19, name: 'Universiti', line: 'lrt', isLeft: true },
        { id: 18, name: 'Kerinchi', line: 'lrt', isLeft: true },
        { id: 17, name: 'Abdullah Hukum', line: 'lrt', isLeft: true },
        { id: 16, name: 'Bangsar', line: 'lrt', isLeft: true },
        { id: 15, name: 'KL Sentral (KJL)', line: 'lrt', isLeft: true },
        
        // MRT stations (Sungai Buloh to Pasar Seni) - GREEN line, top position
        { id: 38, name: 'Sungai Buloh', line: 'mrt', isLeft: true },
        { id: 39, name: 'Kampung Selamat', line: 'mrt', isLeft: true },
        { id: 40, name: 'Kwasa Damansara', line: 'mrt', isLeft: true },
        { id: 41, name: 'Kwasa Sentral', line: 'mrt', isLeft: true },
        { id: 42, name: 'Kota Damansara', line: 'mrt', isLeft: true },
        { id: 43, name: 'Surian', line: 'mrt', isLeft: true },
        { id: 44, name: 'Mutiara Damansara', line: 'mrt', isLeft: true },
        { id: 45, name: 'Bandar Utama', line: 'mrt', isLeft: true },
        { id: 46, name: 'TTDI', line: 'mrt', isLeft: true },
        { id: 47, name: 'Phileo Damansara', line: 'mrt', isLeft: true },
        { id: 48, name: 'Pusat Bandar Damansara', line: 'mrt', isLeft: true },
        { id: 49, name: 'Semantan', line: 'mrt', isLeft: true },
        { id: 50, name: 'Muzium Negara', line: 'mrt', isLeft: true },
        
        // LRT stations (Pasar Seni to Gombak) - RED line, top position (after crossing)
        { id: 13, name: 'Masjid Jamek (KJL)', line: 'lrt', isLeft: false },
        { id: 12, name: 'Dang Wangi', line: 'lrt', isLeft: false },
        { id: 11, name: 'Kampung Baru', line: 'lrt', isLeft: false },
        { id: 10, name: 'KLCC', line: 'lrt', isLeft: false },
        { id: 9, name: 'Ampang Park', line: 'lrt', isLeft: false },
        { id: 8, name: 'Damai', line: 'lrt', isLeft: false },
        { id: 7, name: 'Dato\' Keramat', line: 'lrt', isLeft: false },
        { id: 6, name: 'Jelatek', line: 'lrt', isLeft: false },
        { id: 5, name: 'Setiawangsa', line: 'lrt', isLeft: false },
        { id: 4, name: 'Sri Rampai', line: 'lrt', isLeft: false },
        { id: 3, name: 'Wangsa Maju', line: 'lrt', isLeft: false },
        { id: 2, name: 'Taman Melati', line: 'lrt', isLeft: false },
        { id: 1, name: 'Gombak', line: 'lrt', isLeft: false },
        
        // MRT stations (Pasar Seni to Kajang) - GREEN line, bottom position (after crossing)
        { id: 52, name: 'Merdeka', line: 'mrt', isLeft: false },
        { id: 53, name: 'Bukit Bintang', line: 'mrt', isLeft: false },
        { id: 54, name: 'Tun Razak Exchange (TRX)', line: 'mrt', isLeft: false },
        { id: 55, name: 'Cochrane', line: 'mrt', isLeft: false },
        { id: 56, name: 'Maluri (SBK)', line: 'mrt', isLeft: false },
        { id: 57, name: 'Taman Pertama', line: 'mrt', isLeft: false },
        { id: 58, name: 'Taman Midah', line: 'mrt', isLeft: false },
        { id: 59, name: 'Taman Mutiara', line: 'mrt', isLeft: false },
        { id: 60, name: 'Taman Connaught', line: 'mrt', isLeft: false },
        { id: 61, name: 'Taman Suntex', line: 'mrt', isLeft: false },
        { id: 62, name: 'Sri Raya', line: 'mrt', isLeft: false },
        { id: 63, name: 'Bandar Tun Hussein Onn', line: 'mrt', isLeft: false },
        { id: 64, name: 'Batu 11 Cheras', line: 'mrt', isLeft: false },
        { id: 65, name: 'Bukit Dukung', line: 'mrt', isLeft: false },
        { id: 66, name: 'Sungai Jernih', line: 'mrt', isLeft: false },
        { id: 67, name: 'Stadium Kajang', line: 'mrt', isLeft: false },
        { id: 68, name: 'Kajang', line: 'mrt', isLeft: false }
      ];
      
      // Draw lines
      // LRT line - bottom left, top right
      svg.innerHTML += `<line class="line-lrt" x1="${xStart}" y1="${bottomLineY}" x2="${interchangeX}" y2="${bottomLineY}"/>`;
      svg.innerHTML += `<line class="line-lrt" x1="${interchangeX}" y1="${topLineY}" x2="${xEnd}" y2="${topLineY}"/>`;
      
      // MRT line - top left, bottom right
      svg.innerHTML += `<line class="line-mrt" x1="${xStart}" y1="${topLineY}" x2="${interchangeX}" y2="${topLineY}"/>`;
      svg.innerHTML += `<line class="line-mrt" x1="${interchangeX}" y1="${bottomLineY}" x2="${xEnd}" y2="${bottomLineY}"/>`;
      
      // Interchange crossing lines
      svg.innerHTML += `<line class="line-main" x1="${interchangeX-30}" y1="${bottomLineY}" x2="${interchangeX+30}" y2="${topLineY}" stroke-width="4" stroke-dasharray="5,5"/>`;
      svg.innerHTML += `<line class="line-main" x1="${interchangeX-30}" y1="${topLineY}" x2="${interchangeX+30}" y2="${bottomLineY}" stroke-width="4" stroke-dasharray="5,5"/>`;
      
      // Separate stations by line and position
      const lrtLeft = allStations.filter(s => s.line === 'lrt' && s.isLeft);
      const lrtRight = allStations.filter(s => s.line === 'lrt' && !s.isLeft);
      const mrtLeft = allStations.filter(s => s.line === 'mrt' && s.isLeft);
      const mrtRight = allStations.filter(s => s.line === 'mrt' && !s.isLeft);
      
      // Draw LRT stations (left side - bottom line)
      lrtLeft.forEach((station, i) => {
        const x = xStart + (i * (interchangeX - xStart) / lrtLeft.length);
        svg.innerHTML += `<circle class="station-dot lrt" cx="${x}" cy="${bottomLineY}" r="13"
          onclick="selectStation('${station.name}')" id="dot-${station.id}"/>`;
        svg.innerHTML += `<g transform="translate(${x},${bottomLineY + 32}) rotate(${labelAngle})">
          <text class="station-label">${station.name}</text></g>`;
      });
      
      // Draw LRT stations (right side - top line)
      lrtRight.forEach((station, i) => {
        const x = interchangeX + ((i + 1) * (1880 - interchangeX) / (lrtRight.length + 1));
        svg.innerHTML += `<circle class="station-dot lrt" cx="${x}" cy="${topLineY}" r="13"
          onclick="selectStation('${station.name}')" id="dot-${station.id}"/>`;
        svg.innerHTML += `<g transform="translate(${x},${topLineY + 20}) rotate(${labelAngle})">
          <text class="station-label">${station.name}</text></g>`;
      });
      
      // Draw MRT stations (left side - top line)
      mrtLeft.forEach((station, i) => {
        const x = xStart + (i * (interchangeX - xStart) / mrtLeft.length);
        svg.innerHTML += `<circle class="station-dot mrt" cx="${x}" cy="${topLineY}" r="13"
          onclick="selectStation('${station.name}')" id="dot-${station.id}"/>`;
        svg.innerHTML += `<g transform="translate(${x},${topLineY + 20}) rotate(${labelAngle})">
          <text class="station-label">${station.name}</text></g>`;
      });
      
      // Draw MRT stations (right side - bottom line)
      mrtRight.forEach((station, i) => {
        const x = interchangeX + ((i + 1) * (1865 - interchangeX) / (mrtRight.length + 1));
        svg.innerHTML += `<circle class="station-dot mrt" cx="${x}" cy="${bottomLineY}" r="13"
          onclick="selectStation('${station.name}')" id="dot-${station.id}"/>`;
        svg.innerHTML += `<g transform="translate(${x},${bottomLineY + 32}) rotate(${labelAngle})">
          <text class="station-label">${station.name}</text></g>`;
      });
      
      // Draw interchange station (Pasar Seni)
      svg.innerHTML += `<circle class="station-dot interchange" cx="${interchangeX}" cy="${(topLineY + bottomLineY) / 2}" r="15"
        onclick="selectStation('Pasar Seni')" id="dot-pasar-seni"/>`;
      svg.innerHTML += `<g transform="translate(${985},${175}) rotate(${36})">
        <text class="station-label">Pasar Seni</text></g>`;
      
      highlightSelectedDots();
    }

    function highlightSelectedDots() {
      // Get all station dots
      const dots = document.querySelectorAll('.station-dot');
      const fromStation = document.getElementById('fromStation').value;
      const toStation = document.getElementById('toStation').value;
      
      dots.forEach(dot => {
        // Get station name from the onclick attribute
        const onclickAttr = dot.getAttribute('onclick');
        const match = onclickAttr.match(/selectStation\('([^']+)'\)/);
        if (match) {
          const stationName = match[1];
          if (stationName === fromStation || stationName === toStation) {
            dot.classList.add('selected');
          } else {
            dot.classList.remove('selected');
          }
        }
      });
    }

    window.selectStation = function(name) {
      const from = document.getElementById('fromStation');
      const to = document.getElementById('toStation');
      
      // Handle Pasar Seni selection - use the appropriate database name based on context
      if (name === 'Pasar Seni') {
        // For simplicity, default to Pasar Seni (KJL) but this could be improved
        name = 'Pasar Seni (KJL)';
      }
      
      if (from.value === name) {
        to.value = name;
      } else {
        from.value = name;
      }
      highlightSelectedDots();
      fetchRouteData();
      fetchArrivals();
    }

    document.getElementById('fromStation').addEventListener('change', ()=>{
      highlightSelectedDots(); fetchRouteData(); fetchArrivals();
    });
    document.getElementById('toStation').addEventListener('change', ()=>{
      highlightSelectedDots(); fetchRouteData(); fetchArrivals();
    });

    async function fetchRouteData() {
      const fromName = document.getElementById('fromStation').value;
      const toName = document.getElementById('toStation').value;
      if (fromName === toName) {
        document.getElementById('fee').textContent = 'RM--.--';
        document.getElementById('duration').textContent = '-- mins';
        return;
      }
      const from = stationMap[fromName], to = stationMap[toName];
      const [fareRes, timeRes] = await Promise.all([
        fetch(`/fare?from=${from}&to=${to}`),
        fetch(`/time?from=${from}&to=${to}`)
      ]);
      const fare = await fareRes.json();
      const time = await timeRes.json();
      document.getElementById('fee').textContent = fare.price !== undefined ? `RM${Number(fare.price).toFixed(2)}` : 'N/A';
      document.getElementById('duration').textContent = time.minutes !== undefined ? `${time.minutes} mins` : 'N/A';
    }

    // Store arrival times - no more fake timers, use server data directly  
    let stationArrivals = {};
    let refreshInterval = null;

    async function fetchArrivals() {
      const from = stationMap[document.getElementById('fromStation').value];
      const to = stationMap[document.getElementById('toStation').value];
      
      if (!from || !to) return;
      
      // Update station titles
      document.getElementById('station1Title').textContent = document.getElementById('fromStation').selectedOptions[0].text;
      document.getElementById('station2Title').textContent = document.getElementById('toStation').selectedOptions[0].text;
      
      try {
        // Get station info and real-time arrivals from server
        const [station1Info, station2Info, arr1, arr2] = await Promise.all([
          fetch(`/station_info?station_id=${from}`).then(res => res.json()),
          fetch(`/station_info?station_id=${to}`).then(res => res.json()),
          fetch(`/arrivals?station_id=${from}`).then(res => res.json()),
          fetch(`/arrivals?station_id=${to}`).then(res => res.json())
        ]);
        
        // Store current arrivals data
        stationArrivals = {
          station1: arr1,
          station2: arr2,
          station1Info,
          station2Info
        };
        
        // Display current data
        createStationTables('station1Tables', station1Info, arr1);
        createStationTables('station2Tables', station2Info, arr2);
        
        console.log(`Fetched ${arr1.length} arrivals for station 1, ${arr2.length} arrivals for station 2`);
        
      } catch (error) {
        console.error('Error fetching arrivals:', error);
      }
    }

    function createStationTables(containerId, stationInfo, arrivals) {
      const container = document.getElementById(containerId);
      
      if (stationInfo.is_lrt) {
        // LRT station: show Gombak and Putra Heights directions
        const gombakArrivals = arrivals.filter(a => a.destination.includes('Gombak')).slice(0, 3);
        const putraArrivals = arrivals.filter(a => a.destination.includes('Putra Heights')).slice(0, 3);
        
        container.innerHTML = `
          <div>
            <h4 style="text-align: center; margin: 0 0 10px 0; color: #e53e3e; font-size: 1.1rem;">To Gombak</h4>
            <table class="arr-table">
              <thead><tr><th>Time</th><th>Platform</th></tr></thead>
              <tbody>${gombakArrivals.length > 0 ? 
                gombakArrivals.map(r => `<tr><td>${formatArrivalTime(r.minutes, r.seconds)}</td><td>Train ${r.train_id}</td></tr>`).join('') : 
                '<tr><td colspan="2" style="text-align: center; color: #94a0bc;">No trains</td></tr>'}
              </tbody>
            </table>
          </div>
          <div>
            <h4 style="text-align: center; margin: 0 0 10px 0; color: #e53e3e; font-size: 1.1rem;">To Putra Heights</h4>
            <table class="arr-table">
              <thead><tr><th>Time</th><th>Platform</th></tr></thead>
              <tbody>${putraArrivals.length > 0 ? 
                putraArrivals.map(r => `<tr><td>${formatArrivalTime(r.minutes, r.seconds)}</td><td>Train ${r.train_id}</td></tr>`).join('') : 
                '<tr><td colspan="2" style="text-align: center; color: #94a0bc;">No trains</td></tr>'}
              </tbody>
            </table>
          </div>
        `;
      } else if (stationInfo.is_mrt) {
        // MRT station: show Sungai Buloh and Kajang directions
        const bulohArrivals = arrivals.filter(a => a.destination.includes('Sungai Buloh')).slice(0, 3);
        const kajangArrivals = arrivals.filter(a => a.destination.includes('Kajang')).slice(0, 3);
        
        container.innerHTML = `
          <div>
            <h4 style="text-align: center; margin: 0 0 10px 0; color: #38a169; font-size: 1.1rem;">To Sungai Buloh</h4>
            <table class="arr-table">
              <thead><tr><th>Time</th><th>Platform</th></tr></thead>
              <tbody>${bulohArrivals.length > 0 ? 
                bulohArrivals.map(r => `<tr><td>${formatArrivalTime(r.minutes, r.seconds)}</td><td>Train ${r.train_id}</td></tr>`).join('') : 
                '<tr><td colspan="2" style="text-align: center; color: #94a0bc;">No trains</td></tr>'}
              </tbody>
            </table>
          </div>
          <div>
            <h4 style="text-align: center; margin: 0 0 10px 0; color: #38a169; font-size: 1.1rem;">To Kajang</h4>
            <table class="arr-table">
              <thead><tr><th>Time</th><th>Platform</th></tr></thead>
              <tbody>${kajangArrivals.length > 0 ? 
                kajangArrivals.map(r => `<tr><td>${formatArrivalTime(r.minutes, r.seconds)}</td><td>Train ${r.train_id}</td></tr>`).join('') : 
                '<tr><td colspan="2" style="text-align: center; color: #94a0bc;">No trains</td></tr>'}
              </tbody>
            </table>
          </div>
        `;
      } else {
        container.innerHTML = '<div style="text-align: center; color: #94a0bc;">Station type unknown</div>';
      }
    }

    function formatArrivalTime(minutes, seconds) {
      if (minutes === 0 && seconds <= 30) {
        return '<span style="color: #e53e3e; font-weight: bold;">Arriving</span>';
      } else if (minutes === 0 && seconds < 60) {
        return '<span style="color: #f56500; font-weight: bold;">1 min</span>';
      } else {
        // Format as MM:SS
        const formattedMinutes = minutes.toString();
        const formattedSeconds = seconds.toString().padStart(2, '0');
        return `${formattedMinutes}:${formattedSeconds}`;
      }
    }

    // Socket.IO event handlers - refresh when real trains move
    socket.on('train_update', function(data) {
      console.log('Real train movement detected - refreshing arrivals');
      fetchArrivals(); // Get updated real train positions
    });

    // Refresh arrivals regularly to get real-time data from server
    setInterval(() => {
      if (document.getElementById('fromStation').value && document.getElementById('toStation').value) {
        console.log('Regular refresh - fetching current train positions');
        fetchArrivals();
      }
    }, 3000); // Refresh every 3 seconds to show real train movement

    document.addEventListener('DOMContentLoaded', loadStations);
  </script>
</body>
</html>