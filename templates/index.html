<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Metro Route Simulator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Modern, friendly Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    body {
      background: #f7f8fa;
      color: #232340;
      font-family: 'Urbanist', Arial, Helvetica, sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    .container {
      max-width: 1120px;
      margin: 0 auto;
      padding: 34px 20px 0 20px;
    }
    h1 {
      font-family: 'Urbanist', sans-serif;
      font-weight: 900;
      font-size: 2.7rem;
      text-align: center;
      letter-spacing: 0.04em;
      margin: 0 0 24px 0;
    }
    .summary-row {
      display: flex; justify-content: space-between; margin-bottom: 40px; align-items: flex-end;
      flex-wrap: wrap;
      gap: 18px;
    }
    .summary-box {
      background: #fff;
      border-radius: 22px;
      padding: 22px 38px 22px 38px;
      min-width: 270px;
      margin: 5px;
      box-shadow: 0 8px 40px 0 #99caff32;
      text-align: center;
      font-size: 2.2rem;
      color: #212174;
      font-weight: 900;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .summary-label { font-size: 1.2rem; color: #94a0bc; font-weight: 700; margin-bottom: 0.28em; letter-spacing:0.04em;}
    #fee, #duration { color: #2140c2; font-size:2.5rem; letter-spacing:0.03em; }
    .controls {
      display: flex; justify-content: center; align-items: center; margin-bottom: 42px;
      gap: 22px;
    }
    .dropdown {
      font-family: 'Urbanist', Arial, Helvetica, sans-serif;
      font-size: 1.18rem;
      background: #fafdff;
      color: #2e2e5a;
      border: 2px solid #dde6f7;
      border-radius: 16px;
      padding: 14px 38px 14px 20px;
      min-width: 260px;
      box-sizing: border-box;
      margin: 0 8px;
      font-weight: 700;
      outline: none;
      box-shadow: 0 2px 18px #dde6f4bb;
      transition: border 0.15s;
      cursor: pointer;
      text-align: center;
      text-overflow: ellipsis;
    }
    .dropdown:focus { border: 2px solid #4ba5ff; }
    /* Metro lines */
    .metro-map {
      margin: 36px 0 44px 0;
      position: relative;
      height: 265px;
      width: 100%;
      max-width: 1000px;
      background: none;
      display: block;
    }
    .station-dot {
      cursor: pointer;
      stroke: #fff;
      stroke-width: 3.5;
      fill: #30b7e8;
      transition: fill 0.18s, stroke 0.2s;
    }
    .station-dot.selected {
      fill: #FFA300;
      stroke: #232340;
      stroke-width: 6;
    }
    .station-label {
      font-family: 'Urbanist', Arial, Helvetica, sans-serif;
      font-size: 1.01em;
      fill: #232340;
      font-weight: 700;
      text-anchor: end;
      pointer-events: none;
      user-select: none;
      transform: rotate(-36deg);
      /* will be applied via JS for SVG */
    }
    .line-main { stroke: #30b7e8; stroke-width: 7; }
    /* Tables */
    .tables-row {
      display: flex;
      gap: 36px;
      justify-content: center;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    .arr-table {
      background: #fff;
      border-radius: 20px;
      min-width: 260px;
      padding: 0 16px 18px 16px;
      margin-bottom: 10px;
      font-size: 1.15rem;
      color: #232340;
      box-shadow: 0 4px 26px #e3e8f2;
      border: 1.5px solid #e7e7ef;
    }
    .arr-table th, .arr-table td {
      border-bottom: 1.1px solid #e8e8ef;
      padding: 9px 14px;
      text-align: center;
    }
    .arr-table th {
      color: #38b0e6;
      font-weight: 900;
      font-size: 1.11em;
      background: #f7fafd;
      border-radius: 8px 8px 0 0;
    }
    .arr-table tr:last-child td { border-bottom: none; }
    @media (max-width: 950px) {
      .tables-row { flex-direction: column; align-items: center; gap: 20px; }
      .metro-map { height: 180px; }
      .container { padding: 18px; }
      .dropdown { min-width: 160px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Metro Route Simulator</h1>
    <div class="summary-row">
      <div class="summary-box">
        <div class="summary-label">Total Fee</div>
        <div id="fee">RMXX.XX</div>
      </div>
      <div class="summary-box">
        <div class="summary-label">Duration</div>
        <div id="duration">XX mins</div>
      </div>
    </div>

    <div class="controls">
      <select id="fromStation" class="dropdown"></select>
      <span style="font-size:2.2rem;color:#b3b3c7;">&hellip;</span>
      <select id="toStation" class="dropdown"></select>
    </div>

    <svg class="metro-map" id="metroSVG" width="1000" height="220"></svg>

    <div class="tables-row">
      <table class="arr-table">
        <thead><tr><th>Time</th><th>Destination</th></tr></thead>
        <tbody id="arr1"></tbody>
      </table>
      <table class="arr-table">
        <thead><tr><th>Time</th><th>Destination</th></tr></thead>
        <tbody id="arr2"></tbody>
      </table>
    </div>
  </div>
  <script>
    let stations = [];
    let stationMap = {};

    async function loadStations() {
      const res = await fetch('/stations');
      stations = await res.json();
      stationMap = {};
      stations.forEach(s => { stationMap[s.station_id] = s.name; stationMap[s.name] = s.station_id; });
      renderDropdowns();
      renderMetroSVG();
      document.getElementById('fromStation').value = stations[0].name;
      document.getElementById('toStation').value = stations[1].name;
      fetchRouteData();
      fetchArrivals();
    }

    function renderDropdowns() {
      let from = document.getElementById('fromStation');
      let to = document.getElementById('toStation');
      from.innerHTML = to.innerHTML = '';
      stations.forEach(s => {
        from.innerHTML += `<option value="${s.name}">${s.name}</option>`;
        to.innerHTML += `<option value="${s.name}">${s.name}</option>`;
      });
    }

    function renderMetroSVG() {
      const svg = document.getElementById('metroSVG');
      svg.innerHTML = '';
      const y = 125;
      const xStart = 65, xEnd = 960;
      const n = stations.length;
      const labelAngle = -38; // degrees
      svg.innerHTML += `<line class="line-main" x1="${xStart}" y1="${y}" x2="${xEnd}" y2="${y}"/>`;
      stations.forEach((s, i) => {
        let x = xStart + i*(xEnd-xStart)/(n-1);
        svg.innerHTML += `<circle class="station-dot" cx="${x}" cy="${y}" r="13"
          onclick="selectStation('${s.name}')" id="dot-${s.station_id}"/>`;
        // Place rotated text below the dot
        svg.innerHTML += `<g transform="translate(${x},${y+32}) rotate(${labelAngle})">
          <text class="station-label">${s.name}</text></g>`;
      });
      highlightSelectedDots();
    }

    function highlightSelectedDots() {
      stations.forEach(s => {
        const dot = document.getElementById('dot-' + s.station_id);
        if (!dot) return;
        if (s.name === document.getElementById('fromStation').value ||
            s.name === document.getElementById('toStation').value) {
          dot.classList.add('selected');
        } else {
          dot.classList.remove('selected');
        }
      });
    }

    window.selectStation = function(name) {
      const from = document.getElementById('fromStation');
      const to = document.getElementById('toStation');
      if (from.value === name) {
        to.value = name;
      } else {
        from.value = name;
      }
      highlightSelectedDots();
      fetchRouteData();
      fetchArrivals();
    }

    document.getElementById('fromStation').addEventListener('change', ()=>{
      highlightSelectedDots(); fetchRouteData(); fetchArrivals();
    });
    document.getElementById('toStation').addEventListener('change', ()=>{
      highlightSelectedDots(); fetchRouteData(); fetchArrivals();
    });

    async function fetchRouteData() {
      const fromName = document.getElementById('fromStation').value;
      const toName = document.getElementById('toStation').value;
      if (fromName === toName) {
        document.getElementById('fee').textContent = 'RM--.--';
        document.getElementById('duration').textContent = '-- mins';
        return;
      }
      const from = stationMap[fromName], to = stationMap[toName];
      const [fareRes, timeRes] = await Promise.all([
        fetch(`/fare?from=${from}&to=${to}`),
        fetch(`/time?from=${from}&to=${to}`)
      ]);
      const fare = await fareRes.json();
      const time = await timeRes.json();
      document.getElementById('fee').textContent = fare.price !== undefined ? `RM${Number(fare.price).toFixed(2)}` : 'N/A';
      document.getElementById('duration').textContent = time.minutes !== undefined ? `${time.minutes} mins` : 'N/A';
    }

    async function fetchArrivals() {
      const from = stationMap[document.getElementById('fromStation').value];
      const to = stationMap[document.getElementById('toStation').value];
      const arr1 = await fetch(`/arrivals?station_id=${from}`).then(res=>res.json());
      const arr2 = await fetch(`/arrivals?station_id=${to}`).then(res=>res.json());
      document.getElementById('arr1').innerHTML = arr1.map(r=>`<tr><td>${r.minutes}</td><td>${r.destination}</td></tr>`).join('');
      document.getElementById('arr2').innerHTML = arr2.map(r=>`<tr><td>${r.minutes}</td><td>${r.destination}</td></tr>`).join('');
    }

    document.addEventListener('DOMContentLoaded', loadStations);
  </script>
</body>
</html>